import pandas as pd
import math
from collections import defaultdict
import matplotlib.pyplot as plt
import matplotlib.patches as patches
import re


def calculate_weight(length, width, count):
    """计算单块格栅重量(kg)"""
    area = length * width * count / 1e6  # 面积(m²)
    return 30.8 * area  # 重量(kg)


def extract_gratings(file_content):
    """从文件内容提取格栅信息"""
    gratings = []

    # 找到"清单"工作表部分
    start_marker = "> metadata.sheet_name: 清单"
    end_marker = "> metadata.sheet_name: Sheet1"

    # 提取清单部分内容
    start_idx = file_content.find(start_marker)
    end_idx = file_content.find(end_marker)

    if start_idx == -1 or end_idx == -1:
        print("未找到清单工作表内容")
        return gratings

    sheet_content = file_content[start_idx:end_idx]
    lines = sheet_content.split('\n')

    # 处理数据行
    for line in lines:
        if not line.startswith('|') or '板号' in line or '小计' in line or 'EL' in line:
            continue

        # 解析表格行
        cols = [col.strip() for col in line.split('|') if col.strip()]
        if len(cols) < 8:
            continue

        try:
            board_id = cols[0]
            # 处理可能包含#符号的数值
            length = int(re.sub(r'[^\d]', '', cols[2]))
            width = int(re.sub(r'[^\d]', '', cols[3]))
            count = int(re.sub(r'[^\d]', '', cols[4]))
            el = cols[7]

            # 计算总重量
            total_weight = calculate_weight(length, width, count)
            single_weight = total_weight / count if count > 0 else 0

            # 展开多块格栅
            for _ in range(count):
                gratings.append({
                    'id': board_id,
                    'length': length,
                    'width': width,
                    'weight': single_weight,
                    'el': el
                })

        except (ValueError, IndexError) as e:
            print(f"解析错误: {line} | {str(e)}")

    return gratings


def pack_gratings(gratings, max_width=4000, max_height=2000, max_weight=5000):
    """二维装箱算法"""
    # 按EL分组
    groups = defaultdict(list)
    for g in gratings:
        groups[g['el']].append(g)

    # 打包结果
    packs = []
    pack_id = 1

    for el, items in groups.items():
        # 按面积降序排序(提高空间利用率)
        items.sort(key=lambda x: x['length'] * x['width'], reverse=True)

        # 如果组内没有物品，跳过
        if not items:
            continue

        while items:
            # 初始化容器
            pack = {
                'id': f"Pack-{pack_id}",
                'width': 0,
                'height': 0,
                'weight': 0,
                'items': [],
                'positions': [],
                'el': el
            }
            pack_id += 1

            # 当前容器状态
            current_height = 0
            current_level = []
            level_height = 0

            # 尝试添加物品
            i = 0
            while i < len(items):
                item = items[i]

                # 检查重量约束
                if pack['weight'] + item['weight'] > max_weight:
                    i += 1
                    continue

                # 两种旋转方向
                rotations = [
                    (item['length'], item['width']),
                    (item['width'], item['length'])
                ]

                placed = False
                for w, h in rotations:
                    # 检查尺寸约束
                    if w > max_width or h > max_height:
                        continue

                    # 尝试放置在新层
                    if not current_level or (current_level[-1]['x'] + current_level[-1]['w'] + w <= max_width):
                        # 添加到当前层
                        x = current_level[-1]['x'] + current_level[-1]['w'] if current_level else 0
                        y = current_height

                        # 检查是否超出容器宽度
                        if x + w > max_width:
                            continue

                        # 更新容器尺寸
                        pack['width'] = max(pack['width'], x + w)
                        pack['height'] = max(pack['height'], y + h)
                        level_height = max(level_height, h)

                        # 添加到容器
                        pack['items'].append(item)
                        pack['positions'].append((x, y, w, h))
                        pack['weight'] += item['weight']
                        current_level.append({'x': x, 'y': y, 'w': w, 'h': h})
                        items.pop(i)
                        placed = True
                        break

                if not placed:
                    # 尝试新层
                    if current_level and current_height + level_height <= max_height:
                        current_height += level_height
                        current_level = []
                        level_height = 0
                        # 重置索引以重新尝试放置当前物品
                        i = -1  # 将在循环结束时增加为0
                    i += 1
                else:
                    # 成功放置，重置索引以尝试放置下一个物品
                    i = 0 if current_level else i

            # 添加到结果
            if pack['items']:
                packs.append(pack)

    return packs


def visualize_packing(pack):
    """可视化装箱结果"""
    fig, ax = plt.subplots(figsize=(10, 6))
    ax.set_xlim(0, 4000)
    ax.set_ylim(0, 2000)
    ax.set_title(f"包裹: {pack['id']} | EL组: {pack['el']}")
    ax.set_xlabel("宽度 (mm)")
    ax.set_ylabel("高度 (mm)")

    # 绘制容器边界
    container = patches.Rectangle(
        (0, 0), pack['width'], pack['height'],
        linewidth=2, edgecolor='r', facecolor='none', linestyle='--'
    )
    ax.add_patch(container)

    # 绘制每个格栅
    for i, (x, y, w, h) in enumerate(pack['positions']):
        rect = patches.Rectangle(
            (x, y), w, h,
            linewidth=1, edgecolor='blue', facecolor='skyblue', alpha=0.7
        )
        ax.add_patch(rect)
        # 显示板号缩写
        short_id = pack['items'][i]['id'].split('-')[-1]
        ax.text(x + w / 2, y + h / 2, short_id,
                ha='center', va='center', fontsize=8)

    plt.grid(True)
    plt.gca().set_aspect('equal', adjustable='box')
    plt.show()


# ======================== 主程序 ========================
if __name__ == "__main__":
    # 从文件内容解析数据
    file_content = """
[file name]: 生产阿拉木图120E561格栅清单 - 副本.xlsx
[file content begin]
> metadata.sheet_name: 清单
> metadata.sheet_index_num: 1
| A                    | B   | C    | D    | E             | F                       | G             | H               |
|:---------------------|:----|:-----|:-----|:--------------|:------------------------|:--------------|:----------------|
| 阿拉木图120E561 格栅清单     |     |      |      |               |                         |               | EL              |
| 钢格板型号：JG323/30/100FG |     |      |      |               |                         |               |                 |
| 板号                   | 图   | 长度   | 宽度   | 数量            | 面积                      | 重量            |                 |
|                      |     | （mm） | （mm） | 块             | （m^2）                   | （kg）          |                 |
| 120E561-A1           |     | 770  | 287  | 1             | =E5*D5*C5/1000000       | =30.8*F5      | 120E56MX-平台扶梯   |
| 120E561-A2           | #   | 533  | 533  | 1             | =E6*D6*C6/1000000       | =30.8*F6      | 120E56MX-平台扶梯   |
| 120E561-A3           |     | 940  | 993  | 2             | =E7*D7*C7/1000000       | =30.8*F7      | 120E56MX-平台扶梯   |
| 120E561-A4           |     | 1090 | 993  | 9             | =E8*D8*C8/1000000       | =30.8*F8      | 120E56MX-平台扶梯   |
| 120E561-A5           |     | 1090 | 633  | 1             | =E9*D9*C9/1000000       | =30.8*F9      | 120E56MX-平台扶梯   |
| 120E561-A6           |     | 1090 | 663  | 1             | =E10*D10*C10/1000000    | =30.8*F10     | 120E56MX-平台扶梯   |
| 120E561-A7           | #   | 1950 | 873  | 1             | =E11*D11*C11/1000000    | =30.8*F11     | 120E56MX-平台扶梯   |
| 120E561-A8           | #   | 1950 | 903  | 1             | =E12*D12*C12/1000000    | =30.8*F12     | 120E56MX-平台扶梯   |
| 120E561-A9           |     | 1950 | 393  | 1             | =E13*D13*C13/1000000    | =30.8*F13     | 120E56MX-平台扶梯   |
| 120E561-A10          |     | 990  | 993  | 25            | =E14*D14*C14/1000000    | =30.8*F14     | 120E56MX-平台扶梯   |
| 120E561-A11          |     | 990  | 603  | 1             | =E15*D15*C15/1000000    | =30.8*F15     | 120E56MX-平台扶梯   |
| 120E561-A12          |     | 990  | 573  | 1             | =E16*D16*C16/1000000    | =30.8*F16     | 120E56MX-平台扶梯   |
| 120E561-A13          |     | 990  | 933  | 1             | =E17*D17*C17/1000000    | =30.8*F17     | 120E56MX-平台扶梯   |
| 120E561-A14          |     | 1134 | 993  | 2             | =E18*D18*C18/1000000    | =30.8*F18     | 120E56MX-平台扶梯   |
| 120E561-A15          |     | 1134 | 423  | 1             | =E19*D19*C19/1000000    | =30.8*F19     | 120E56MX-平台扶梯   |
| 120E561-A16          |     | 962  | 993  | 2             | =E20*D20*C20/1000000    | =30.8*F20     | 120E56MX-平台扶梯   |
| 120E561-A17          |     | 962  | 423  | 1             | =E21*D21*C21/1000000    | =30.8*F21     | 120E56MX-平台扶梯   |
| 120E561-A18          |     | 1075 | 993  | 2             | =E22*D22*C22/1000000    | =30.8*F22     | 120E56MX-平台扶梯   |
| 120E561-A19          |     | 1075 | 423  | 1             | =E23*D23*C23/1000000    | =30.8*F23     | 120E56MX-平台扶梯   |
| 120E561-A20          |     | 990  | 393  | 1             | =E24*D24*C24/1000000    | =30.8*F24     | 120E56MX-平台扶梯   |
| 120E561-A21          |     | 990  | 723  | 1             | =E25*D25*C25/1000000    | =30.8*F25     | 120E56MX-平台扶梯   |
| 120E561-A22          |     | 1050 | 453  | 1             | =E26*D26*C26/1000000    | =30.8*F26     | 120E56MX-平台扶梯   |
| 120E561-A23          |     | 725  | 993  | 2             | =E27*D27*C27/1000000    | =30.8*F27     | 120E56MX-平台扶梯   |
| 120E561-A24          |     | 725  | 933  | 1             | =E28*D28*C28/1000000    | =30.8*F28     | 120E56MX-平台扶梯   |
| 120E561-A25          |     | 1255 | 993  | 2             | =E29*D29*C29/1000000    | =30.8*F29     | 120E56MX-平台扶梯   |
| 120E561-A26          |     | 1255 | 933  | 1             | =E30*D30*C30/1000000    | =30.8*F30     | 120E56MX-平台扶梯   |
| 120E561-A27          |     | 690  | 993  | 4             | =E31*D31*C31/1000000    | =30.8*F31     | 120E56MX-平台扶梯   |
| 120E561-A28          |     | 690  | 933  | 1             | =E32*D32*C32/1000000    | =30.8*F32     | 120E56MX-平台扶梯   |
| 120E561-A29          |     | 790  | 993  | 15            | =E33*D33*C33/1000000    | =30.8*F33     | 120E56MX-平台扶梯   |
| 120E561-A30          | #   | 1190 | 993  | 1             | =E34*D34*C34/1000000    | =30.8*F34     | 120E56MX-平台扶梯   |
| 120E561-A31          |     | 1190 | 993  | 17            | =E35*D35*C35/1000000    | =30.8*F35     | 120E56MX-平台扶梯   |
| 120E561-A32          |     | 1190 | 513  | 1             | =E36*D36*C36/1000000    | =30.8*F36     | 120E56MX-平台扶梯   |
| 120E561-A33          |     | 1490 | 993  | 14            | =E37*D37*C37/1000000    | =30.8*F37     | 120E56MX-平台扶梯   |
| 120E561-A34          |     | 1490 | 513  | 1             | =E38*D38*C38/1000000    | =30.8*F38     | 120E56MX-平台扶梯   |
| 120E561-A35          |     | 1220 | 993  | 1             | =E39*D39*C39/1000000    | =30.8*F39     | 120E56MX-平台扶梯   |
| 120E561-A36          |     | 1220 | 603  | 1             | =E40*D40*C40/1000000    | =30.8*F40     | 120E56MX-平台扶梯   |
| 120E561-A37          |     | 1220 | 573  | 1             | =E41*D41*C41/1000000    | =30.8*F41     | 120E56MX-平台扶梯   |
| 120E561-A38          |     | 1275 | 993  | 5             | =E42*D42*C42/1000000    | =30.8*F42     | 120E56MX-平台扶梯   |
| 120E561-A39          |     | 1275 | 393  | 1             | =E43*D43*C43/1000000    | =30.8*F43     | 120E56MX-平台扶梯   |
| 120E561-A40          | #   | 1490 | 993  | 1             | =E44*D44*C44/1000000    | =30.8*F44     | 120E56MX-平台扶梯   |
| 120E561-A41          |     | 1090 | 393  | 1             | =E45*D45*C45/1000000    | =30.8*F45     | 120E56MX-平台扶梯   |
| 120E561-A42          |     | 1775 | 993  | 3             | =E46*D46*C46/1000000    | =30.8*F46     | 120E56MX-平台扶梯   |
| 120E561-A43          |     | 1190 | 543  | 2             | =E47*D47*C47/1000000    | =30.8*F47     | 120E56MX-平台扶梯   |
| 120E561-A44          |     | 1490 | 543  | 2             | =E48*D48*C48/1000000    | =30.8*F48     | 120E56MX-平台扶梯   |
| 120E561-A45          |     | 990  | 543  | 8             | =E49*D49*C49/1000000    | =30.8*F49     | 120E56MX-平台扶梯   |
| 120E561-A46          |     | 1390 | 993  | 2             | =E50*D50*C50/1000000    | =30.8*F50     | 120E56MX-平台扶梯   |
| 120E561-A47          |     | 1390 | 423  | 1             | =E51*D51*C51/1000000    | =30.8*F51     | 120E56MX-平台扶梯   |
| 120E561-A48          | #   | 1362 | 993  | 1             | =E52*D52*C52/1000000    | =30.8*F52     | 120E56MX-平台扶梯   |
| 120E561-A49          | #   | 363  | 363  | 1             | =E53*D53*C53/1000000    | =30.8*F53     | 120E56MX-平台扶梯   |
| 120E561-A50          | #   | 540  | 993  | 1             | =E54*D54*C54/1000000    | =30.8*F54     | 120E56MX-平台扶梯   |
| 120E561-A51          |     | 540  | 993  | 1             | =E55*D55*C55/1000000    | =30.8*F55     | 120E56MX-平台扶梯   |
| 120E561-A52          | #   | 540  | 513  | 1             | =E56*D56*C56/1000000    | =30.8*F56     | 120E56MX-平台扶梯   |
| 120E561-A53          | #   | 513  | 513  | 1             | =E57*D57*C57/1000000    | =30.8*F57     | 120E56MX-平台扶梯   |
| 120E561-A54          |     | 690  | 543  | 2             | =E58*D58*C58/1000000    | =30.8*F58     | 120E56MX-平台扶梯   |
| 120E561-A55          | #   | 1141 | 993  | 1             | =E59*D59*C59/1000000    | =30.8*F59     | 120E56MX-平台扶梯   |
| 120E561-A56          |     | 1141 | 513  | 1             | =E60*D60*C60/1000000    | =30.8*F60     | 120E56MX-平台扶梯   |
| 120E561-A57          |     | 1440 | 993  | 1             | =E61*D61*C61/1000000    | =30.8*F61     | 120E56MX-平台扶梯   |
| 120E561-A58          |     | 393  | 840  | 1             | =E62*D62*C62/1000000    | =30.8*F62     | 120E56MX-平台扶梯   |
| 120E561-A59          | #   | 1134 | 993  | 1             | =E63*D63*C63/1000000    | =30.8*F63     | 120E56MX-平台扶梯   |
| 120E561-A60          | #   | 1134 | 873  | 1             | =E64*D64*C64/1000000    | =30.8*F64     | 120E56MX-平台扶梯   |
| 120E561-A61          | #   | 1030 | 993  | 1             | =E65*D65*C65/1000000    | =30.8*F65     | 120E56MX-平台扶梯   |
| 120E561-B1           |     | 1490 | 393  | 1             | =E66*D66*C66/1000000    | =30.8*F66     | 120E512MX-辅助间钢架 |
| 120E561-B2           |     | 1490 | 993  | 2             | =E67*D67*C67/1000000    | =30.8*F67     | 120E512MX-辅助间钢架 |
| 120E561-B3           | #   | 1490 | 993  | 1             | =E68*D68*C68/1000000    | =30.8*F68     | 120E512MX-辅助间钢架 |
| 120E561-B4           |     | 990  | 993  | 21            | =E69*D69*C69/1000000    | =30.8*F69     | 120E512MX-辅助间钢架 |
| 120E561-B5           |     | 1139 | 963  | 1             | =E70*D70*C70/1000000    | =30.8*F70     | 120E512MX-辅助间钢架 |
| 120E561-B6           |     | 1139 | 993  | 2             | =E71*D71*C71/1000000    | =30.8*F71     | 120E512MX-辅助间钢架 |
| 120E561-B7           |     | 990  | 573  | 1             | =E72*D72*C72/1000000    | =30.8*F72     | 120E512MX-辅助间钢架 |
| 120E561-B8           |     | 990  | 543  | 1             | =E73*D73*C73/1000000    | =30.8*F73     | 120E512MX-辅助间钢架 |
| 120E561-B9           |     | 982  | 543  | 1             | =E74*D74*C74/1000000    | =30.8*F74     | 120E512MX-辅助间钢架 |
| 120E561-B10          |     | 982  | 573  | 1             | =E75*D75*C75/1000000    | =30.8*F75     | 120E512MX-辅助间钢架 |
| 120E561-B11          |     | 982  | 993  | 1             | =E76*D76*C76/1000000    | =30.8*F76     | 120E512MX-辅助间钢架 |
| 120E561-B12          |     | 1149 | 543  | 1             | =E77*D77*C77/1000000    | =30.8*F77     | 120E512MX-辅助间钢架 |
| 120E561-B13          |     | 1149 | 573  | 1             | =E78*D78*C78/1000000    | =30.8*F78     | 120E512MX-辅助间钢架 |
| 120E561-B14          |     | 1149 | 993  | 1             | =E79*D79*C79/1000000    | =30.8*F79     | 120E512MX-辅助间钢架 |
| 120E561-B15          |     | 818  | 543  | 1             | =E80*D80*C80/1000000    | =30.8*F80     | 120E512MX-辅助间钢架 |
| 120E561-B16          |     | 818  | 573  | 1             | =E81*D81*C81/1000000    | =30.8*F81     | 120E512MX-辅助间钢架 |
| 120E561-B17          |     | 818  | 993  | 1             | =E82*D82*C82/1000000    | =30.8*F82     | 120E512MX-辅助间钢架 |
| 120E561-B18          |     | 1138 | 633  | 2             | =E83*D83*C83/1000000    | =30.8*F83     | 120E512MX-辅助间钢架 |
| 120E561-B19          |     | 1138 | 993  | 1             | =E84*D84*C84/1000000    | =30.8*F84     | 120E512MX-辅助间钢架 |
| 120E561-B20          |     | 1282 | 633  | 2             | =E85*D85*C85/1000000    | =30.8*F85     | 120E512MX-辅助间钢架 |
| 120E561-B21          |     | 1282 | 993  | 1             | =E86*D86*C86/1000000    | =30.8*F86     | 120E512MX-辅助间钢架 |
| 120E561-B22          |     | 950  | 633  | 2             | =E87*D87*C87/1000000    | =30.8*F87     | 120E512MX-辅助间钢架 |
| 120E561-B23          |     | 950  | 993  | 1             | =E88*D88*C88/1000000    | =30.8*F88     | 120E512MX-辅助间钢架 |
| 120E561-B24          |     | 990  | 633  | 6             | =E89*D89*C89/1000000    | =30.8*F89     | 120E512MX-辅助间钢架 |
| 120E561-B25          |     | 866  | 633  | 2             | =E90*D90*C90/1000000    | =30.8*F90     | 120E512MX-辅助间钢架 |
| 120E561-B26          |     | 866  | 993  | 1             | =E91*D91*C91/1000000    | =30.8*F91     | 120E512MX-辅助间钢架 |
| 120E561-B27          |     | 790  | 633  | 4             | =E92*D92*C92/1000000    | =30.8*F92     | 120E512MX-辅助间钢架 |
| 120E561-B28          |     | 790  | 993  | 2             | =E93*D93*C93/1000000    | =30.8*F93     | 120E512MX-辅助间钢架 |
| 120E561-B29          |     | 640  | 633  | 2             | =E94*D94*C94/1000000    | =30.8*F94     | 120E512MX-辅助间钢架 |
| 120E561-B30          |     | 640  | 993  | 1             | =E95*D95*C95/1000000    | =30.8*F95     | 120E512MX-辅助间钢架 |
| 120E561-B31          |     | 1990 | 453  | 1             | =E96*D96*C96/1000000    | =30.8*F96     | 120E512MX-辅助间钢架 |
| 120E561-B32          |     | 1990 | 513  | 1             | =E97*D97*C97/1000000    | =30.8*F97     | 120E512MX-辅助间钢架 |
| 120E561-B33          |     | 1990 | 993  | 13            | =E98*D98*C98/1000000    | =30.8*F98     | 120E512MX-辅助间钢架 |
| 120E561-B34          |     | 990  | 453  | 1             | =E99*D99*C99/1000000    | =30.8*F99     | 120E512MX-辅助间钢架 |
| 120E561-B35          |     | 990  | 513  | 1             | =E100*D100*C100/1000000 | =30.8*F100    | 120E512MX-辅助间钢架 |
| 120E561-B36          |     | 1190 | 453  | 2             | =E101*D101*C101/1000000 | =30.8*F101    | 120E512MX-辅助间钢架 |
| 120E561-B37          |     | 1190 | 513  | 2             | =E102*D102*C102/1000000 | =30.8*F102    | 120E512MX-辅助间钢架 |
| 120E561-B38          |     | 1190 | 993  | 26            | =E103*D103*C103/1000000 | =30.8*F103    | 120E512MX-辅助间钢架 |
| 120E561-B39          |     | 1090 | 453  | 1             | =E104*D104*C104/1000000 | =30.8*F104    | 120E512MX-辅助间钢架 |
| 120E561-B40          |     | 1090 | 513  | 1             | =E105*D105*C105/1000000 | =30.8*F105    | 120E512MX-辅助间钢架 |
| 120E561-B41          |     | 1090 | 993  | 13            | =E106*D106*C106/1000000 | =30.8*F106    | 120E512MX-辅助间钢架 |
| 120E561-A62          |     | 790  | 783  | 3             | =E107*D107*C107/1000000 | =30.8*F107    | 120E56MX-平台扶梯   |
| 120E561-A63          |     | 990  | 783  | 3             | =E108*D108*C108/1000000 | =30.8*F108    | 120E56MX-平台扶梯   |
| 120E561-A64          | #   | 1280 | 993  | 1             | =E109*D109*C109/1000000 | =30.8*F109    | 120E56MX-平台扶梯   |
| 120E561-A65          |     | 1990 | 483  | 1             | =E110*D110*C110/1000000 | =30.8*F110    | 120E56MX-平台扶梯   |
| 120E561-A66          |     | 1990 | 993  | 12            | =E111*D111*C111/1000000 | =30.8*F111    | 120E56MX-平台扶梯   |
| 120E561-A67          |     | 1190 | 483  | 1             | =E112*D112*C112/1000000 | =30.8*F112    | 120E56MX-平台扶梯   |
| 120E561-A68          |     | 990  | 933  | 1             | =E113*D113*C113/1000000 | =30.8*F113    | 120E56MX-平台扶梯   |
| 120E561-A69          |     | 990  | 993  | 2             | =E114*D114*C114/1000000 | =30.8*F114    | 120E56MX-平台扶梯   |
| 120E561-A70          | #   | 990  | 993  | 1             | =E115*D115*C115/1000000 | =30.8*F115    | 120E56MX-平台扶梯   |
| 120E561-A71          |     | 1090 | 573  | 1             | =E116*D116*C116/1000000 | =30.8*F116    | 120E56MX-平台扶梯   |
| 120E561-A72          |     | 1090 | 603  | 1             | =E117*D117*C117/1000000 | =30.8*F117    | 120E56MX-平台扶梯   |
| 120E561-A73          |     | 890  | 993  | 1             | =E118*D118*C118/1000000 | =30.8*F118    | 120E56MX-平台扶梯   |
| 120E561-C1           | #   | 1063 | 430  | 1             | =E119*D119*C119/1000000 | =30.8*F119    | 120E817MX-楼梯井   |
| 120E561-C2           | #   | 1050 | 430  | 1             | =E120*D120*C120/1000000 | =30.8*F120    | 120E817MX-楼梯井   |
| 120E561-C3           | #   | 1057 | 430  | 1             | =E121*D121*C121/1000000 | =30.8*F121    | 120E817MX-楼梯井   |
| 120E561-C4           |     | 1050 | 550  | 1             | =E122*D122*C122/1000000 | =30.8*F122    | 120E817MX-楼梯井   |
| 120E561-C5           |     | 990  | 993  | 9             | =E123*D123*C123/1000000 | =30.8*F123    | 120E817MX-楼梯井   |
| 120E561-C6           |     | 990  | 633  | 1             | =E124*D124*C124/1000000 | =30.8*F124    | 120E817MX-楼梯井   |
| 120E561-C7           |     | 990  | 663  | 1             | =E125*D125*C125/1000000 | =30.8*F125    | 120E817MX-楼梯井   |
| 120E561-C8           |     | 1190 | 993  | 16            | =E126*D126*C126/1000000 | =30.8*F126    | 120E817MX-楼梯井   |
| 120E561-C9           |     | 1190 | 693  | 4             | =E127*D127*C127/1000000 | =30.8*F127    | 120E817MX-楼梯井   |
| 120E561-C10          |     | 990  | 693  | 2             | =E128*D128*C128/1000000 | =30.8*F128    | 120E817MX-楼梯井   |
| 120E561-C11          |     | 504  | 590  | 1             | =E129*D129*C129/1000000 | =30.8*F129    | 120E817MX-楼梯井   |
| 120E561-C12          |     | 1050 | 672  | 1             | =E130*D130*C130/1000000 | =30.8*F130    | 120E817MX-楼梯井   |
| 120E561-C13          | #   | 1057 | 630  | 1             | =E131*D131*C131/1000000 | =30.8*F131    | 120E817MX-楼梯井   |
| 120E561-C14          | #   | 1430 | 993  | 2             | =E132*D132*C132/1000000 | =30.8*F132    | 120E817MX-楼梯井   |
| 120E561-C15          | #   | 1430 | 993  | 2             | =E133*D133*C133/1000000 | =30.8*F133    | 120E817MX-楼梯井   |
| 120E561-C16          | #   | 1506 | 993  | 2             | =E134*D134*C134/1000000 | =30.8*F134    | 120E817MX-楼梯井   |
| 120E561-C17          | #   | 1506 | 693  | 2             | =E135*D135*C135/1000000 | =30.8*F135    | 120E817MX-楼梯井   |
| 120E561-C18          |     | 510  | 393  | 1             | =E136*D136*C136/1000000 | =30.8*F136    | 120E817MX-楼梯井   |
| 120E561-C19          |     | 1050 | 506  | 3             | =E137*D137*C137/1000000 | =30.8*F137    | 120E817MX-楼梯井   |
| 120E561-C20          |     | 504  | 393  | 2             | =E138*D138*C138/1000000 | =30.8*F138    | 120E817MX-楼梯井   |
| 120E561-C21          |     | 1190 | 693  | 1             | =E139*D139*C139/1000000 | =30.8*F139    | 120E817MX-楼梯井   |
| 120E561-C22          |     | 1050 | 430  | 1             | =E140*D140*C140/1000000 | =30.8*F140    | 120E817MX-楼梯井   |
| 120E561-C23          |     | 1190 | 693  | 1             | =E141*D141*C141/1000000 | =30.8*F141    | 120E817MX-楼梯井   |
| 120E561-C24          | #   | 1340 | 993  | 1             | =E142*D142*C142/1000000 | =30.8*F142    | 120E817MX-楼梯井   |
| 120E561-C25          | #   | 1340 | 993  | 1             | =E143*D143*C143/1000000 | =30.8*F143    | 120E817MX-楼梯井   |
| 120E561-C26          |     | 1057 | 506  | 1             | =E144*D144*C144/1000000 | =30.8*F144    | 120E817MX-楼梯井   |
| 120E561-C27          |     | 504  | 506  | 1             | =E145*D145*C145/1000000 | =30.8*F145    | 120E817MX-楼梯井   |
| 120E561-C28          |     | 1050 | 724  | 1             | =E146*D146*C146/1000000 | =30.8*F146    | 120E817MX-楼梯井   |
| 备件                   |     | 3500 | 1000 | 17            | =E147*D147*C147/1000000 | =30.8*F147    |                 |
| 小计                   |     |      |      | =SUM(E5:E147) | =SUM(F5:F147)           | =SUM(G5:G147) |                 |

> metadata.sheet_name: Sheet1
> metadata.sheet_index_num: 2
| A   | B   | C       | D            | E       | F    | G                          | H            | I   | J   | K   | L    | M    | N    | O   | P   | Q   | R   | S   | T   | U      | V      |
|:----|:----|:--------|:-------------|:--------|:-----|:---------------------------|:-------------|:----|:----|:----|:-----|:-----|:-----|:----|:----|:----|:----|:----|:----|:-------|:-------|
| 净空  | l   | =C2-100 | w            | =E2-120 | h    | =G2-300                    | 包装号          | 1#  |     |     |      |      |      |     |     |     |     |     |     |        |        |
| 外形  | L   | =L2     | W            | =M2     | H    | =N2                        |              |     |     | 1#架 | 3200 | 2200 | 1400 |     |     |     |     |     |     | =R2-E2 | =N2-G2 |
| 序号  | 图号  | 名称      |              | 数量      | 材料   | 单重                         | 总重           | 备注  |     |     |      |      |      |     |     |     |     |     |     |        |        |
| 1   | 按本图 | 槽钢[12   | =C2          | 2       | Q235 | =D4*12.059*0.001           | =G4*E4       |     |     |     |      |      |      |     |     |     |     |     |     |        |        |
| 2   | 按本图 | 槽钢[12   | =E2-15       | 5       | Q235 | =D5*12.059*0.001           | =G5*E5       |     |     |     |      |      |      |     |     |     |     |     |     |        |        |
| 3   | 按本图 | 槽钢[10   | =G2-120      | 4       | Q235 | =D6*10*0.001               | =G6*E6       |     |     |     |      |      |      |     |     |     |     |     |     |        |        |
| 4   | 按本图 | 槽钢[10   | =G2-120-80   | 6       | Q235 | =D7*10*0.001               | =G7*E7       |     |     |     |      |      |      |     |     |     |     |     |     |        |        |
| 5   | 按本图 | 槽钢[8    | =C2-300      | 2       | Q235 | =D8*8.045*0.001            | =G8*E8       |     |     |     |      |      |      |     |     |     |     |     |     |        |        |
| 6   | 按本图 | 钢板δ20   | 280*140      | 4       | Q235 | 5.29                       | =G9*E9       |     |     |     |      |      |      |     |     |     |     |     |     |        |        |
| 7   | 按本图 | 槽钢[10   | =E2-60       | 2       | Q235 | =D10*10*0.001              | =G10*E10     |     |     |     |      |      |      |     |     |     |     |     |     |        |        |
| 8   | 按本图 | 角钢L50*4 | =G2-120-100  | 6       | Q235 | =D11*3.059*0.001           | =G11*E11     |     |     |     |      |      |      |     |     |     |     |     |     |        |        |
| 9   | 按本图 | 槽钢[10   | =C2-130      | 2       | Q235 | =D12*10*0.001              | =G12*E12     |     |     |     |      |      |      |     |     |     |     |     |     |        |        |
| 10  | 按本图 | 钢格板     | JG253/30/100 | 1       | Q235 | =C2*(E2-140)*24.5*0.000001 | =G13*E13     |     |     |     |      |      |      |     |     |     |     |     |     |        |        |
| 11  | 按本图 | 压杆组件φ48 | =E2          | 2       | Q235 | =3.3293*D14/1000           | =G14*E14     |     |     |     |      |      |      |     |     |     |     |     |     |        |        |
| 12  | 按本图 | 钢板δ3    | 600*500      | 2       | Q235 | 7.1                        | =G15*E15     |     |     |     |      |      |      |     |     |     |     |     |     |        |        |
|     |     | 合计      |              |         |      |                            | =SUM(H4:H15) |     |     |     |      |      |      |     |     |     |     |     |     |        |        |

[file content end]
    """

    # 提取格栅数据
    gratings = extract_gratings(file_content)
    print(f"总格栅数量: {len(gratings)}")

    # 执行打包算法
    packs = pack_gratings(gratings)
    print(f"生成包裹数量: {len(packs)}")

    # 打印打包结果
    for i, pack in enumerate(packs):
        print(f"\n包裹 #{i + 1}:")
        print(f"ID: {pack['id']} | EL组: {pack['el']}")
        print(f"尺寸: {pack['width']}x{pack['height']} mm")
        print(f"总重: {pack['weight'] / 1000:.2f} 吨")
        print(f"包含格栅: {len(pack['items'])}块")

        # 可视化前5个包裹
        if i < 5:
            visualize_packing(pack)